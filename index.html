<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI4Gov-X Consortium Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; background-color: #f4f4f4; }
        
        /* --- LEGEND --- */
        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            margin-left: 20px; /* Added margin for bottomleft position */
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.9;
        }

        /* --- PROJECT OVERVIEW PANEL --- */
        .info.stats {
            background: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 340px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-top: 10px;
            margin-right: 10px;
        }
        .info.stats.minimized {
            width: 280px; 
            height: auto;
        }
        .stats-header {
            background: #0056b3;
            color: white;
            padding: 12px 15px;
            font-size: 15px; 
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .stats-header:hover { background: #004494; }
        .toggle-btn { font-size: 18px; font-weight: bold; line-height: 1; margin-left: 10px; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 10px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        .info.stats.minimized .stats-grid,
        .info.stats.minimized .partner-scroll { display: none; }
        
        .stat-item {
            text-align: center;
            background: white;
            padding: 8px 5px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #0056b3;
        }
        .stat-number { display: block; font-size: 20px; font-weight: 800; color: #0056b3; }
        .stat-label { font-size: 10px; color: #666; text-transform: uppercase; font-weight: 600; margin-top: 2px;}

        /* Scrollable Sidebar List */
        .partner-scroll {
            overflow-y: auto;
            flex-grow: 1;
            padding: 10px;
            background: #fff;
        }
        .list-group { margin-bottom: 15px; }
        .list-group-title {
            font-size: 12px;
            font-weight: bold;
            color: #0056b3;
            background: #eef6ff;
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sidebar-item {
            font-size: 11px;
            padding: 4px 8px;
            border-bottom: 1px solid #f5f5f5;
            line-height: 1.3;
        }
        .sidebar-item b { color: #333; }
        .sidebar-country { color: #888; font-size: 10px; float: right; }

        /* --- MODAL (POPUP) STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; width: 650px; max-width: 90%; max-height: 85vh;
            border-radius: 8px; display: flex; flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            background: #f8f9fa; border-radius: 8px 8px 0 0;
        }
        .modal-title { font-size: 18px; font-weight: bold; color: #333; }
        .modal-close { cursor: pointer; font-size: 24px; color: #888; line-height: 1; }
        .modal-close:hover { color: #333; }
        
        .modal-content { padding: 20px; overflow-y: auto; font-size: 13px; line-height: 1.5; }
        
        /* Modal Content Styling */
        .modal-section-title {
            font-size: 14px; font-weight: bold; color: #0056b3;
            margin-top: 15px; margin-bottom: 5px; border-bottom: 2px solid #eef6ff;
            padding-bottom: 2px;
        }
        .modal-continent-header {
            font-size: 15px; font-weight: bold; color: #333; background: #eee;
            padding: 5px 10px; margin-top: 20px; border-radius: 4px;
        }
        .modal-subsection-title { font-weight: bold; color: #555; margin-bottom: 3px; font-size: 13px; margin-top: 8px; margin-left: 10px;}
        .modal-list { list-style: none; padding: 0; margin: 0; }
        .modal-list li { padding: 4px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center;}
        .modal-list li span { flex-grow: 1; padding-right: 10px; }
        .modal-list li b { white-space: nowrap; }

        /* Popup on Map */
        .leaflet-popup-content { font-size: 13px; line-height: 1.4; width: 280px; }
        .popup-header { font-weight: bold; font-size: 15px; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px;}
        .tag {
            display: inline-block; padding: 2px 5px; border-radius: 3px;
            font-size: 10px; color: white; font-weight: bold; margin-left: 5px;
        }
        .tag-current { background-color: #0056b3; } 
        .tag-candidate { background-color: #5bc0de; color: #fff; } 
    </style>
</head>
<body>

<div id="map"></div>

<div id="infoModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Details</div>
            <div class="modal-close" onclick="closeModal()">&times;</div>
        </div>
        <div class="modal-content" id="modalBody"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- Configuration ---
    const COLOR_CURRENT = "#0056b3";    
    const COLOR_CANDIDATE = "#88CCEE"; 
    const COLOR_BOTH = "#2A2A72";     
    const COLOR_DEFAULT = "#dddddd";   

    // --- Continent Mapping ---
    const continentMap = {
        // Europe
        "Italy": "Europe", "Spain": "Europe", "Belgium": "Europe", "Estonia": "Europe", 
        "Portugal": "Europe", "Bulgaria": "Europe", "Hungary": "Europe", "Croatia": "Europe", 
        "Netherlands": "Europe", "France": "Europe", "Austria": "Europe", "Greece": "Europe", 
        "Romania": "Europe", "Slovakia": "Europe", "Ukraine": "Europe", "Cyprus": "Europe", 
        "Serbia": "Europe", "Montenegro": "Europe", "Slovenia": "Europe", "Lithuania": "Europe", 
        "Kosovo": "Europe", "Sweden": "Europe", "Finland": "Europe", "Norway": "Europe", 
        "Denmark": "Europe", "Poland": "Europe", "Bosnia and Herzegovina": "Europe", 
        "Turkey": "Europe", "Albania": "Europe", "Germany": "Europe", "North Macedonia": "Europe",
        "Latvia": "Europe",
        // Oceania
        "Australia": "Oceania",
        // Asia
        "United Arab Emirates": "Asia", "South Korea": "Asia",
        // Africa
        "Morocco": "Africa", "Egypt": "Africa",
        // Americas
        "Argentina": "South America", "Ecuador": "South America", "Colombia": "South America", 
        "Peru": "South America", "Bolivia": "South America", "Costa Rica": "North America", 
        "Guatemala": "North America"
    };

    // --- PARTNER DATA ---
    const partnerData = {
        // --- Full Partners ---
        "Italy": [
            {code: "POLI.d", name: "POLI.DESIGN S.C.R.L.", type: "Current Partner"},
            {code: "POLIMI", name: "POLITECNICO DI MILANO", type: "Current Partner"},
            {code: "UNIBS", name: "UNIVERSITA DEGLI STUDI DI BRESCIA", type: "Current Partner"},
            {code: "UNIBO", name: "ALMA MATER STUDIORUM - UNIVERSITA DI BOLOGNA", type: "Current Partner"},
            {code: "TUV.IT", name: "TUV THURINGEN ITALIA SRL", type: "Current Partner"},
            {code: "COGN", name: "COGNITO S.R.L.", type: "Current Partner"},
            {code: "DOKI", name: "DOKIMAZO S.R.L. SOCIETA BENEFIT", type: "Current Partner"},
            {code: "PROMOS", name: "PROMOS SRL SB", type: "Candidate Associated"}
        ],
        "Germany": [
            {code: "FAU", name: "FRIEDRICH-ALEXANDER-UNIVERSITAET ERLANGEN-NUERNBERG", type: "Current Partner"},
            {code: "TPSDA", name: "Teaching Public Service in the Digital Age c/o Interalia gGmbH", type: "Candidate Associated"}
        ],
        "Spain": [
            {code: "UPM", name: "UNIVERSIDAD POLITECNICA DE MADRID", type: "Current Partner"},
            {code: "IE", name: "INSTITUTO DE EMPRESA SL", type: "Current Partner"},
            {code: "MUSOL", name: "Fundación MUSOL", type: "Current Partner"},
            {code: "IF.E", name: "Inspiring Futures Europe", type: "Current Partner"},
            {code: "KYRA", name: "KYRA SUNRISE SL", type: "Current Partner"},
            {code: "DDS", name: "BYFACILITY SL", type: "Current Partner"},
            {code: "UPSA", name: "Universidad Pontificia de Salamanca", type: "Candidate Associated"}
        ],
        "Belgium": [
            {code: "FARI", name: "VRIJE UNIVERSITEIT BRUSSEL", type: "Current Partner"},
            {code: "KUL", name: "KATHOLIEKE UNIVERSITEIT LEUVEN", type: "Current Partner"},
            {code: "CEPS", name: "CENTRE FOR EUROPEAN POLICY STUDIES", type: "Current Partner"},
            {code: "VUC", name: "VUCABLE", type: "Current Partner"},
            {code: "RIE", name: "RE-IMAGINE EUROPA", type: "Current Partner"},
            {code: "TRS", name: "THE RIGHT STREET", type: "Current Partner"},
            {code: "DE", name: "Digital Europe", type: "Current Associated"},
            {code: "TotalEU", name: "TotalEU Production", type: "Candidate Associated"}
        ],
        "Estonia": [
            {code: "EBS", name: "SIHTASUTUS ESTONIAN BUSINESS SCHOOL", type: "Current Partner"},
            {code: "Tartu", name: "University of Tartu", type: "Candidate Associated"}
        ],
        "Portugal": [
            {code: "Tec+", name: "ASSOCIACAO PARA O DESENVOLVIMENTO DO INSTITUTO SUPERIOR TECNICO", type: "Current Partner"},
            {code: "PBS", name: "ASSOCIACAO PORTO BUSINESS SCHOOL", type: "Current Partner"},
            {code: "INA", name: "Instituto Nacional de Administração, I.P.", type: "Candidate Associated"},
            {code: "UNU-EGOV", name: "United Nations University", type: "Candidate Associated"}
        ],
        "Bulgaria": [
            {code: "RAM", name: "REGIONALNO SDRUZHENIE NA OBSTINI TSENTRALNA STARA PLANINA", type: "Current Partner"},
            {code: "ITService", name: "ITService ltd.", type: "Candidate Associated"},
            {code: "Gabrovo", name: "Municipality of Gabrovo", type: "Candidate Associated"},
            {code: "Elena", name: "Municipality of Elena", type: "Candidate Associated"}
        ],
        "Hungary": [
            {code: "BME", name: "BUDAPESTI MUSZAKI ES GAZDASAGTUDOMANYI EGYETEM", type: "Current Partner"},
            {code: "UP", name: "University of Pecs", type: "Current Associated"}
        ],
        "Croatia": [
            {code: "FIDIT", name: "SVEUCILISTE U RIJECI", type: "Current Partner"},
            {code: "EFRI", name: "SVEUCILISTE U RIJECI EKONOMSKI FAKULTET", type: "Current Partner"}
        ],
        "Netherlands": [{code: "TUD", name: "TECHNISCHE UNIVERSITEIT DELFT", type: "Current Partner"}],
        "France": [
            {code: "UL", name: "UNIVERSITE DE LILLE", type: "Current Partner"},
            {code: "ESSEC", name: "ASSOCIATION GROUPE ESSEC", type: "Current Partner"}
        ],
        "Austria": [{code: "DUK", name: "UNIVERSITAT FUR WEITERBILDUNG KREMS", type: "Current Partner"}],
        "Greece": [
            {code: "UAE", name: "PANEPISTIMIO AIGAIOU", type: "Current Partner"},
            {code: "EPLO", name: "EUROPEAN PUBLIC LAW ORGANIZATION", type: "Current Partner"}
        ],
        "Romania": [{code: "UPB", name: "UNIVERSITATEA NATIONALA DE STIINTASI TEHNOLOGIE POLITEHNICA BUCURESTI", type: "Current Partner"}],
        "Slovakia": [{code: "TUKE", name: "TECHNICKA UNIVERZITA V KOSICIACH", type: "Current Partner"}],
        "Ukraine": [{code: "KNTU", name: "KHERSON NATIONAL TECHNICAL UNIVERSITY", type: "Current Partner"}],
        "Cyprus": [{code: "ANETEL", name: "ANAPTYXIAKI ETAIREIA EPARCHION LARNAKAS", type: "Current Partner"}],
        "Serbia": [{code: "E.INT", name: "GORAN PASTROVIC", type: "Current Partner"}],
        "Montenegro": [{code: "ReSPA", name: "ReSPA", type: "Current Associated"}],

        // --- Candidates ---
        "Latvia": [{code: "ITI", name: "Information Technology Institute", type: "Candidate Associated"}],
        "North Macedonia": [{code: "UKIM", name: "Ss Cyril and Methodius University in Skopje, Faculty of Economics", type: "Candidate Associated"}],
        "Slovenia": [
            {code: "JSI", name: "Jožef Stefan Institute", type: "Candidate Associated"},
            {code: "E-zavod", name: "E-zavod", type: "Candidate Associated"}
        ],
        "Lithuania": [{code: "Visionary", name: "Visionary Analytics (UAB)", type: "Candidate Associated"}],
        "Kosovo": [{code: "Customs", name: "Kosovo Customs", type: "Candidate Associated"}],
        "Sweden": [
            {code: "Experio", name: "Region Värmland / Experio Lab", type: "Candidate Associated"},
            {code: "Linköping", name: "Linköping University", type: "Candidate Associated"}
        ],
        "Finland": [
            {code: "CLANED", name: "Learning Intelligence Group LIG Oy", type: "Candidate Associated"},
            {code: "LAUREA", name: "Laurea University of Applied Sciences", type: "Candidate Associated"}
        ],
        "Norway": [
            {code: "NTNU", name: "Norwegian University of Science and Technology", type: "Candidate Associated"},
            {code: "SINTEF", name: "SINTEF Digital", type: "Candidate Associated"}
        ],
        "Denmark": [{code: "CBS", name: "Copenhagen Business School", type: "Candidate Associated"}],
        "Poland": [
            {code: "CEZAMAT", name: "CEZAMAT PW Sp. z o.o.", type: "Candidate Associated"},
            {code: "SGH", name: "Warsaw School of Economics", type: "Candidate Associated"}
        ],
        "Bosnia and Herzegovina": [
            {code: "SERDA", name: "Sarajevo Economic Region Development Agency", type: "Candidate Associated"},
            {code: "PREDA", name: "Razvojna agencija Grada Prijedor", type: "Candidate Associated"},
            {code: "AduRS", name: "Civil Service Agency of the Republic of Srpska", type: "Candidate Associated"}
        ],
        "Turkey": [{code: "Galatasaray", name: "University Galatasaray - Faculty of Law", type: "Candidate Associated"}],
        "Albania": [
            {code: "IAM", name: "Institute for Albanian Municipalities", type: "Candidate Associated"},
            {code: "AI Albania", name: "Albanian Center for Artificial Intelligence", type: "Candidate Associated"}
        ],
        
        "Australia": [{code: "EAC", name: "Ethical AI Consulting Pty Ltd", type: "Candidate Associated"}],
        "United Arab Emirates": [{code: "CFG", name: "Center for the Future of Government (MBRSG)", type: "Candidate Associated"}],
        "South Korea": [{code: "IFG", name: "Institute for Future Government, Yonsei University", type: "Candidate Associated"}],
        
        "Morocco": [
            {code: "ENSIAS", name: "École Nationale Supérieure d’Informatique et d’Analyse des Systèmes", type: "Candidate Associated"},
            {code: "Intilaka", name: "Association al Intilaka", type: "Candidate Associated"}
        ],
        "Egypt": [
            {code: "BTU", name: "Beni Suef Technological University", type: "Candidate Associated"},
            {code: "BRISK", name: "BRISK Business", type: "Candidate Associated"}
        ],
        "Argentina": [{code: "FLACSO", name: "Facultad Latinoamerica de Ciencias Sociales", type: "Candidate Associated"}],
        "Costa Rica": [{code: "DEMUCA", name: "Fundación DEMUCA", type: "Candidate Associated"}],
        "Guatemala": [{code: "DEMUCA", name: "Fundación DEMUCA", type: "Candidate Associated"}],
        "Ecuador": [{code: "UASB", name: "Universidad Andina Simón Bolívar (Andean Community)", type: "Candidate Associated"}],
        "Colombia": [{code: "UASB", name: "Universidad Andina Simón Bolívar (Andean Community)", type: "Candidate Associated"}],
        "Peru": [{code: "UASB", name: "Universidad Andina Simón Bolívar (Andean Community)", type: "Candidate Associated"}],
        "Bolivia": [{code: "UASB", name: "Universidad Andina Simón Bolívar (Andean Community)", type: "Candidate Associated"}],
    };

    // --- Stats Logic ---
    let appStats = null;

    function calculateStats() {
        let stats = {
            currentSet: new Set(),
            assocSet: new Set(),
            candidateSet: new Set(),
            countries: 0,
            continents: new Set(),
            data: { full: {}, assoc: {}, candidates: {} }
        };

        for (const [country, partners] of Object.entries(partnerData)) {
            stats.countries++;
            const cont = continentMap[country] || "Other";
            stats.continents.add(cont);

            // Init Data Structure
            if (!stats.data.full[country]) stats.data.full[country] = [];
            if (!stats.data.assoc[country]) stats.data.assoc[country] = [];
            if (!stats.data.candidates[cont]) stats.data.candidates[cont] = {};
            if (!stats.data.candidates[cont][country]) stats.data.candidates[cont][country] = [];

            partners.forEach(p => {
                if (p.type === "Current Partner") {
                    stats.currentSet.add(p.code);
                    stats.data.full[country].push(p);
                } else if (p.type === "Current Associated") {
                    stats.assocSet.add(p.code);
                    stats.data.assoc[country].push(p);
                } else if (p.type === "Candidate Associated") {
                    stats.candidateSet.add(p.code);
                    stats.data.candidates[cont][country].push(p);
                }
            });
        }
        return stats;
    }

    // --- Modal Logic ---
    function openModal(type) {
        const stats = appStats;
        let title = "";
        let html = "";

        if (type === 'full') {
            title = `Full Partners (${stats.currentSet.size})`;
            html = `<p><b>Full Partners by Country:</b></p>`;
            for (const [country, list] of Object.entries(stats.data.full)) {
                if (list.length === 0) continue;
                html += `<div class="modal-section-title">${country}</div><ul class="modal-list">`;
                list.forEach(p => html += `<li><span>${p.name}</span> <b>${p.code}</b></li>`);
                html += `</ul>`;
            }
        } 
        else if (type === 'assoc') {
            title = `Associated Partners (${stats.assocSet.size})`;
            html = `<p><b>Associated Partners by Country:</b></p>`;
            for (const [country, list] of Object.entries(stats.data.assoc)) {
                if (list.length === 0) continue;
                html += `<div class="modal-section-title">${country}</div><ul class="modal-list">`;
                list.forEach(p => html += `<li><span>${p.name}</span> <b>${p.code}</b></li>`);
                html += `</ul>`;
            }
        }
        else if (type === 'candidate') {
            title = `Candidate Associated Partners (${stats.candidateSet.size})`;
            html = `<p><b>Candidates by Continent & Country:</b></p>`;
            
            const continents = Object.keys(stats.data.candidates).sort();
            continents.forEach(cont => {
                const countries = stats.data.candidates[cont];
                let hasData = false;
                for (let c in countries) if (countries[c].length > 0) hasData = true;
                
                if (hasData) {
                    html += `<div class="modal-continent-header">${cont}</div>`;
                    for (const [country, list] of Object.entries(countries)) {
                        if (list.length === 0) continue;
                        html += `<div class="modal-subsection-title">${country}</div><ul class="modal-list" style="margin-left:15px;">`;
                        list.forEach(p => html += `<li><span>${p.name}</span> <b>${p.code}</b></li>`);
                        html += `</ul>`;
                    }
                }
            });
        }
        else if (type === 'countries') {
            title = `Countries Covered (${stats.countries})`;
            html = `<p><b>Countries by Continent:</b></p>`;
            const groups = {};
            for (const country of Object.keys(partnerData).sort()) {
                const cont = continentMap[country] || "Other";
                if (!groups[cont]) groups[cont] = [];
                groups[cont].push(country);
            }
            for (const [cont, list] of Object.entries(groups)) {
                html += `<div class="modal-section-title">${cont}</div><div class="modal-subsection">${list.join(', ')}</div>`;
            }
        }
        else if (type === 'continents') {
            title = `Continents Covered (${stats.continents.size})`;
            html = `<p><b>Activity Overview by Continent:</b></p>`;
            const groups = {};
            for (const [country, partners] of Object.entries(partnerData)) {
                const cont = continentMap[country] || "Other";
                if (!groups[cont]) groups[cont] = {countries: [], partners: 0};
                groups[cont].countries.push(country);
                groups[cont].partners += partners.length;
            }
            for (const [cont, data] of Object.entries(groups)) {
                html += `<div class="modal-section-title">${cont}</div>
                         <div class="modal-subsection">
                            <div>${data.countries.length} Countries involved</div>
                            <div style="font-size:11px; color:#666; margin-top:3px;">${data.countries.join(', ')}</div>
                         </div>`;
            }
        }

        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('infoModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('infoModal').style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == document.getElementById('infoModal')) {
            closeModal();
        }
    }

    // --- Initialize Map ---
    const map = L.map('map').setView([20.0, 10.0], 2); 

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // Fetch GeoJSON
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
        .then(response => response.json())
        .then(data => {
            L.geoJson(data, {
                style: function(feature) {
                    const name = feature.properties.name;
                    let key = name;
                    // Fix naming mismatches
                    if (name === "Republic of Korea") key = "South Korea"; 
                    if (name === "Republic of Serbia") key = "Serbia";
                    if (name === "The Netherlands") key = "Netherlands";
                    if (name === "United Republic of Tanzania") key = "Tanzania";
                    if (name.includes("Macedonia")) key = "North Macedonia";
                    
                    const partners = partnerData[key];
                    
                    // Determine Status
                    let hasCurrent = false;
                    let hasCandidate = false;
                    if (partners) {
                        partners.forEach(p => {
                            if (p.type.includes("Current")) hasCurrent = true;
                            if (p.type.includes("Candidate")) hasCandidate = true;
                        });
                    }

                    let color = COLOR_DEFAULT;
                    if (hasCurrent && hasCandidate) color = COLOR_BOTH;
                    else if (hasCurrent) color = COLOR_CURRENT;
                    else if (hasCandidate) color = COLOR_CANDIDATE;

                    return { fillColor: color, weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7 };
                },
                onEachFeature: function(feature, layer) {
                    const name = feature.properties.name;
                    let key = name;
                    if (name === "Republic of Korea") key = "South Korea"; 
                    if (name === "Republic of Serbia") key = "Serbia";
                    if (name === "The Netherlands") key = "Netherlands";
                    if (name.includes("Macedonia")) key = "North Macedonia";
                    
                    const partners = partnerData[key];
                    if (partners) {
                        let popupHtml = `<div class="popup-header">${key}</div><ul class="partner-list">`;
                        partners.forEach(p => {
                            let tagClass = p.type.includes("Current") ? "tag-current" : "tag-candidate";
                            let tagName = p.type === "Current Associated" ? "Assoc. Partner" : (p.type === "Candidate Associated" ? "Candidate" : "Partner");
                            popupHtml += `<li><b>${p.code}</b><br>${p.name}<span class="tag ${tagClass}">${tagName}</span></li>`;
                        });
                        popupHtml += "</ul>";
                        layer.bindPopup(popupHtml);
                        
                        layer.on({
                            mouseover: function(e) { e.target.setStyle({ weight: 2, color: '#666', fillOpacity: 0.9 }); e.target.openPopup(); },
                            mouseout: function(e) { e.target.setStyle({ weight: 1, color: 'white', fillOpacity: 0.7 }); }
                        });
                    }
                }
            }).addTo(map);
        });

    // --- UI Logic ---
    appStats = calculateStats(); 

    var statsControl = L.control({position: 'topright'});

    statsControl.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info stats');
        div.id = 'projectOverview';
        
        const createSidebarList = (set, dataObj, type) => {
            let html = "";
            const countries = Object.keys(dataObj).sort();
            const grouped = {};
            countries.forEach(c => {
                const cont = continentMap[c] || "Other";
                if(!grouped[cont]) grouped[cont] = [];
                const items = dataObj[c].filter(p => {
                    if(type === 'full') return p.type === 'Current Partner';
                    if(type === 'assoc') return p.type === 'Current Associated';
                    return true;
                });
                if(items.length > 0) grouped[cont].push({country: c, items: items});
            });

            for (const [cont, countryList] of Object.entries(grouped)) {
                if(countryList.length === 0) continue;
                html += `<div style="font-size:10px; font-weight:bold; color:#888; margin-top:5px; margin-left:5px;">${cont}</div>`;
                countryList.forEach(obj => {
                    obj.items.forEach(p => html += `<div class="sidebar-item"><b>${p.code}</b> ${p.name.substring(0,25)}${p.name.length>25?'...':''} <span class="sidebar-country">${obj.country}</span></div>`);
                });
            }
            return html;
        };

        const createCandidateSidebar = () => {
            let html = "";
            const continents = Object.keys(appStats.data.candidates).sort();
            continents.forEach(cont => {
                const countries = appStats.data.candidates[cont];
                let hasItems = false;
                let innerHtml = "";
                for(const [c, list] of Object.entries(countries)) {
                    if(list.length > 0) {
                        hasItems = true;
                        list.forEach(p => {
                            innerHtml += `<div class="sidebar-item"><b>${p.code}</b> ${p.name.substring(0,25)}${p.name.length>25?'...':''} <span class="sidebar-country">${c}</span></div>`;
                        });
                    }
                }
                if(hasItems) html += `<div style="font-size:10px; font-weight:bold; color:#888; margin-top:5px; margin-left:5px;">${cont}</div>` + innerHtml;
            });
            return html;
        }

        var html = `
            <div class="stats-header" onclick="toggleStats()">
                <span>AI4Gov-X Consortium Composition</span>
                <span class="toggle-btn" id="toggleIcon">−</span>
            </div>
            <div class="stats-grid">
                <div class="stat-item" onclick="openModal('full')">
                    <span class="stat-number">${appStats.currentSet.size}</span>
                    <span class="stat-label">Full Partners</span>
                </div>
                <div class="stat-item" onclick="openModal('assoc')">
                    <span class="stat-number">${appStats.assocSet.size}</span>
                    <span class="stat-label">Assoc. Partners</span>
                </div>
                <div class="stat-item" onclick="openModal('candidate')">
                    <span class="stat-number">${appStats.candidateSet.size}</span>
                    <span class="stat-label">Candidate Assoc. Partners</span>
                </div>
                <div class="stat-item" onclick="openModal('countries')">
                    <span class="stat-number">${appStats.countries}</span>
                    <span class="stat-label">Countries Covered</span>
                </div>
                <div class="stat-item" style="grid-column: span 2" onclick="openModal('continents')">
                    <span class="stat-number">${appStats.continents.size}</span>
                    <span class="stat-label">Continents Covered</span>
                </div>
            </div>
            <div class="partner-scroll">
                 <div class="list-group">
                    <div class="list-group-title">Candidate Assoc. Partners</div>
                    ${createCandidateSidebar()}
                </div>
                <div class="list-group">
                    <div class="list-group-title">Assoc. Partners</div>
                    ${createSidebarList(appStats.assocSet, appStats.data.assoc, 'assoc')}
                </div>
                <div class="list-group">
                    <div class="list-group-title">Full Partners</div>
                    ${createSidebarList(appStats.currentSet, appStats.data.full, 'full')}
                </div>
            </div>
        `;
        div.innerHTML = html;
        L.DomEvent.disableScrollPropagation(div);
        L.DomEvent.disableClickPropagation(div);
        return div;
    };
    statsControl.addTo(map);

    function toggleStats() {
        const div = document.getElementById('projectOverview');
        const icon = document.getElementById('toggleIcon');
        if (div.classList.contains('minimized')) {
            div.classList.remove('minimized');
            icon.innerText = "−";
        } else {
            div.classList.add('minimized');
            icon.innerText = "+";
        }
    }

    // --- Legend ---
    var legend = L.control({position: 'bottomleft'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += '<h4>Legend</h4>';
        div.innerHTML += '<i style="background:' + COLOR_CURRENT + '"></i> Full Partners<br>';
        div.innerHTML += '<i style="background:' + COLOR_CANDIDATE + '"></i> Candidate Assoc. Partners<br>';
        div.innerHTML += '<i style="background:' + COLOR_BOTH + '"></i> Covered by Both<br>';
        return div;
    };
    legend.addTo(map);

</script>
</body>
</html>
