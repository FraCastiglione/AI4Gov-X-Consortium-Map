<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI4Gov-X Partner Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; background-color: #f4f4f4; }
        
        /* Legend Styles */
        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.9;
        }
        
        /* Stats Panel Styles */
        .info.stats {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            width: 300px;
            max-height: 80vh; /* Prevents it from being too tall */
            display: flex;
            flex-direction: column;
        }
        .stats-header {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-item {
            text-align: center;
            background: #f9f9f9;
            padding: 5px;
            border-radius: 4px;
        }
        .stat-number {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: #0056b3;
        }
        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        /* Scrollable List Styles */
        .partner-scroll {
            overflow-y: auto;
            flex-grow: 1;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .list-section {
            margin-bottom: 15px;
        }
        .list-section h5 {
            margin: 0 0 5px 0;
            font-size: 13px;
            color: #333;
            background: #eee;
            padding: 5px;
        }
        .list-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 11px;
        }
        .list-section li {
            padding: 2px 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        /* Popup Styles */
        .leaflet-popup-content {
            font-size: 13px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            width: 280px;
        }
        .popup-header {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 8px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            color: #333;
        }
        .partner-list { list-style: none; padding: 0; margin: 0; }
        .partner-list li { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dotted #eee; }
        .tag {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            color: white;
            font-weight: bold;
            margin-left: 5px;
        }
        .tag-current { background-color: #0056b3; } 
        .tag-candidate { background-color: #5bc0de; color: #fff; } 
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // --- Configuration ---
    const COLOR_CURRENT = "#0056b3";    // Standard Blue
    const COLOR_CANDIDATE = "#88CCEE";  // Light Blue
    const COLOR_BOTH = "#2A2A72";       // Deep Blue/Indigo (Overlap)
    const COLOR_DEFAULT = "#dddddd";    // Grey

    // --- Continent Mapping Helper ---
    // Maps countries to continents for stats calculation
    const continentMap = {
        "Italy": "Europe", "Spain": "Europe", "Belgium": "Europe", "Estonia": "Europe", 
        "Portugal": "Europe", "Bulgaria": "Europe", "Hungary": "Europe", "Croatia": "Europe", 
        "Netherlands": "Europe", "France": "Europe", "Austria": "Europe", "Greece": "Europe", 
        "Romania": "Europe", "Slovakia": "Europe", "Ukraine": "Europe", "Cyprus": "Europe", 
        "Serbia": "Europe", "Montenegro": "Europe", "Slovenia": "Europe", "Lithuania": "Europe", 
        "Kosovo": "Europe", "Sweden": "Europe", "Finland": "Europe", "Norway": "Europe", 
        "Denmark": "Europe", "Poland": "Europe", "Bosnia and Herzegovina": "Europe", 
        "Turkey": "Europe", "Albania": "Europe", "Germany": "Europe",
        "Australia": "Oceania",
        "United Arab Emirates": "Asia", "South Korea": "Asia",
        "Morocco": "Africa", "Egypt": "Africa",
        "Argentina": "South America", "Ecuador": "South America", "Colombia": "South America", 
        "Peru": "South America", "Bolivia": "South America", "Costa Rica": "North America", 
        "Guatemala": "North America"
    };

    // --- Data Source ---
    const partnerData = {
        // --- Current & Mixed Partners ---
        "Italy": [
            {code: "POLI.d", name: "POLI.DESIGN S.C.R.L.", type: "Current Partner"},
            {code: "POLIMI", name: "POLITECNICO DI MILANO", type: "Current Partner"},
            {code: "UNIBS", name: "UNIVERSITA DEGLI STUDI DI BRESCIA", type: "Current Partner"},
            {code: "UNIBO", name: "ALMA MATER STUDIORUM - UNIVERSITA DI BOLOGNA", type: "Current Partner"},
            {code: "TUV.IT", name: "TUV THURINGEN ITALIA SRL", type: "Current Partner"},
            {code: "COGN", name: "COGNITO S.R.L.", type: "Current Partner"},
            {code: "DOKI", name: "DOKIMAZO S.R.L. SOCIETA BENEFIT", type: "Current Partner"},
            {code: "PROMOS", name: "PROMOS SRL SB", type: "Candidate Associated"}
        ],
        "Germany": [
            {code: "FAU", name: "FRIEDRICH-ALEXANDER-UNIVERSITAET ERLANGEN-NUERNBERG", type: "Current Partner"},
            {code: "TPSDA", name: "Teaching Public Service in the Digital Age c/o Interalia gGmbH", type: "Candidate Associated"}
        ],
        "Spain": [
            {code: "UPM", name: "UNIVERSIDAD POLITECNICA DE MADRID", type: "Current Partner"},
            {code: "IE", name: "INSTITUTO DE EMPRESA SL", type: "Current Partner"},
            {code: "MUSOL", name: "Fundación MUSOL", type: "Current Partner"},
            {code: "IF.E", name: "Inspiring Futures Europe", type: "Current Partner"},
            {code: "KYRA", name: "KYRA SUNRISE SL", type: "Current Partner"},
            {code: "DDS", name: "BYFACILITY SL", type: "Current Partner"},
            {code: "UPSA", name: "Universidad Pontificia de Salamanca", type: "Candidate Associated"}
        ],
        "Belgium": [
            {code: "FARI", name: "VRIJE UNIVERSITEIT BRUSSEL", type: "Current Partner"},
            {code: "KUL", name: "KATHOLIEKE UNIVERSITEIT LEUVEN", type: "Current Partner"},
            {code: "CEPS", name: "CENTRE FOR EUROPEAN POLICY STUDIES", type: "Current Partner"},
            {code: "VUC", name: "VUCABLE", type: "Current Partner"},
            {code: "RIE", name: "RE-IMAGINE EUROPA", type: "Current Partner"},
            {code: "TRS", name: "THE RIGHT STREET", type: "Current Partner"},
            {code: "DE", name: "Digital Europe", type: "Current Associated"},
            {code: "TotalEU", name: "TotalEU Production", type: "Candidate Associated"}
        ],
        "Estonia": [
            {code: "EBS", name: "SIHTASUTUS ESTONIAN BUSINESS SCHOOL", type: "Current Partner"},
            {code: "Tartu", name: "University of Tartu", type: "Candidate Associated"}
        ],
        "Portugal": [
            {code: "Tec+", name: "ASSOCIACAO PARA O DESENVOLVIMENTO DO INSTITUTO SUPERIOR TECNICO", type: "Current Partner"},
            {code: "PBS", name: "ASSOCIACAO PORTO BUSINESS SCHOOL", type: "Current Partner"},
            {code: "INA", name: "Instituto Nacional de Administração, I.P.", type: "Candidate Associated"},
            {code: "UNU-EGOV", name: "United Nations University", type: "Candidate Associated"}
        ],
        "Bulgaria": [
            {code: "RAM", name: "REGIONALNO SDRUZHENIE NA OBSTINI TSENTRALNA STARA PLANINA", type: "Current Partner"},
            {code: "ITService", name: "ITService ltd.", type: "Candidate Associated"},
            {code: "Gabrovo", name: "Municipality of Gabrovo", type: "Candidate Associated"},
            {code: "Elena", name: "Municipality of Elena", type: "Candidate Associated"}
        ],
        "Hungary": [
            {code: "BME", name: "BUDAPESTI MUSZAKI ES GAZDASAGTUDOMANYI EGYETEM", type: "Current Partner"},
            {code: "UP", name: "University of Pecs", type: "Current Associated"}
        ],
        // --- Current Partners Only ---
        "Croatia": [
            {code: "FIDIT", name: "SVEUCILISTE U RIJECI", type: "Current Partner"},
            {code: "EFRI", name: "SVEUCILISTE U RIJECI EKONOMSKI FAKULTET", type: "Current Partner"}
        ],
        "Netherlands": [{code: "TUD", name: "TECHNISCHE UNIVERSITEIT DELFT", type: "Current Partner"}],
        "France": [
            {code: "UL", name: "UNIVERSITE DE LILLE", type: "Current Partner"},
            {code: "ESSEC", name: "ASSOCIATION GROUPE ESSEC", type: "Current Partner"}
        ],
        "Austria": [{code: "DUK", name: "UNIVERSITAT FUR WEITERBILDUNG KREMS", type: "Current Partner"}],
        "Greece": [
            {code: "UAE", name: "PANEPISTIMIO AIGAIOU", type: "Current Partner"},
            {code: "EPLO", name: "EUROPEAN PUBLIC LAW ORGANIZATION", type: "Current Partner"}
        ],
        "Romania": [{code: "UPB", name: "UNIVERSITATEA NATIONALA DE STIINTASI TEHNOLOGIE POLITEHNICA BUCURESTI", type: "Current Partner"}],
        "Slovakia": [{code: "TUKE", name: "TECHNICKA UNIVERZITA V KOSICIACH", type: "Current Partner"}],
        "Ukraine": [{code: "KNTU", name: "KHERSON NATIONAL TECHNICAL UNIVERSITY", type: "Current Partner"}],
        "Cyprus": [{code: "ANETEL", name: "ANAPTYXIAKI ETAIREIA EPARCHION LARNAKAS", type: "Current Partner"}],
        "Serbia": [{code: "E.INT", name: "GORAN PASTROVIC", type: "Current Partner"}],
        "Montenegro": [{code: "ReSPA", name: "ReSPA", type: "Current Associated"}],

        // --- Candidates Only ---
        "Slovenia": [
            {code: "JSI", name: "Jožef Stefan Institute", type: "Candidate Associated"},
            {code: "E-zavod", name: "E-zavod", type: "Candidate Associated"}
        ],
        "Lithuania": [
            {code: "Visionary", name: "Visionary Analytics (UAB)", type: "Candidate Associated"}
        ],
        "Kosovo": [
            {code: "Customs", name: "Kosovo Customs", type: "Candidate Associated"}
        ],
        "Sweden": [
            {code: "Experio", name: "Region Värmland / Experio Lab", type: "Candidate Associated"},
            {code: "Linköping", name: "Linköping University", type: "Candidate Associated"}
        ],
        "Finland": [
            {code: "CLANED", name: "Learning Intelligence Group LIG Oy", type: "Candidate Associated"},
            {code: "LAUREA", name: "Laurea University of Applied Sciences", type: "Candidate Associated"}
        ],
        "Norway": [
            {code: "NTNU", name: "Norwegian University of Science and Technology", type: "Candidate Associated"},
            {code: "SINTEF", name: "SINTEF Digital", type: "Candidate Associated"}
        ],
        "Denmark": [{code: "CBS", name: "Copenhagen Business School", type: "Candidate Associated"}],
        "Poland": [
            {code: "CEZAMAT", name: "CEZAMAT PW Sp. z o.o.", type: "Candidate Associated"},
            {code: "SGH", name: "Warsaw School of Economics", type: "Candidate Associated"}
        ],
        "Bosnia and Herzegovina": [
            {code: "SERDA", name: "Sarajevo Economic Region Development Agency", type: "Candidate Associated"},
            {code: "PREDA", name: "Razvojna agencija Grada Prijedor", type: "Candidate Associated"},
            {code: "AduRS", name: "Civil Service Agency of the Republic of Srpska", type: "Candidate Associated"}
        ],
        "Turkey": [{code: "Galatasaray", name: "University Galatasaray - Faculty of Law", type: "Candidate Associated"}],
        "Albania": [{code: "IAM", name: "Institute for Albanian Municipalities", type: "Candidate Associated"}],
        
        // --- Global Candidates ---
        "Australia": [
            {code: "EAC", name: "Ethical AI Consulting Pty Ltd", type: "Candidate Associated"}
        ],
        "United Arab Emirates": [
            {code: "CFG", name: "Center for the Future of Government (MBRSG)", type: "Candidate Associated"}
        ],
        "South Korea": [{code: "IFG", name: "Institute for Future Government, Yonsei University", type: "Candidate Associated"}],
        
        // --- Africa & Americas ---
        "Morocco": [
            {code: "ENSIAS", name: "École Nationale Supérieure d’Informatique et d’Analyse des Systèmes", type: "Candidate Associated"},
            {code: "Intilaka", name: "Association al Intilaka", type: "Candidate Associated"}
        ],
        "Egypt": [
            {code: "BTU", name: "Beni Suef Technological University", type: "Candidate Associated"},
            {code: "BRISK", name: "BRISK Business", type: "Candidate Associated"}
        ],
        "Argentina": [{code: "FLACSO", name: "Facultad Latinoamerica de Ciencias Sociales", type: "Candidate Associated"}],
        "Costa Rica": [{code: "DEMUCA", name: "Fundación DEMUCA", type: "Candidate Associated"}],
        "Guatemala": [{code: "DEMUCA", name: "Fundación DEMUCA", type: "Candidate Associated"}],
        "Ecuador": [{code: "UASB", name: "Universidad Andina Simón Bolívar (Andean Community)", type: "Candidate Associated"}],
        "Colombia": [{code: "UASB", name: "Universidad Andina Simón Bolívar (Andean Community)", type: "Candidate Associated"}],
        "Peru": [{code: "UASB", name: "Universidad Andina Simón Bolívar (Andean Community)", type: "Candidate Associated"}],
        "Bolivia": [{code: "UASB", name: "Universidad Andina Simón Bolívar (Andean Community)", type: "Candidate Associated"}],
    };

    // --- Statistics Calculation ---
    function calculateStats() {
        let stats = {
            currentPartners: 0,
            associatedPartners: 0,
            candidatePartners: 0,
            countries: 0,
            continents: new Set(),
            lists: {
                current: [],
                associated: [],
                candidate: []
            }
        };

        for (const [country, partners] of Object.entries(partnerData)) {
            stats.countries++;
            
            // Count continent
            const cont = continentMap[country];
            if (cont) stats.continents.add(cont);

            partners.forEach(p => {
                if (p.type === "Current Partner") {
                    stats.currentPartners++;
                    stats.lists.current.push(`${p.name} (${p.code}) - ${country}`);
                } else if (p.type === "Current Associated") {
                    stats.associatedPartners++;
                    stats.lists.associated.push(`${p.name} (${p.code}) - ${country}`);
                } else if (p.type === "Candidate Associated") {
                    stats.candidatePartners++;
                    stats.lists.candidate.push(`${p.name} (${p.code}) - ${country}`);
                }
            });
        }
        return stats;
    }

    // --- Map Logic ---
    function getCountryStatus(partners) {
        let hasCurrent = false;
        let hasCandidate = false;
        partners.forEach(p => {
            if (p.type.includes("Current")) hasCurrent = true;
            if (p.type.includes("Candidate")) hasCandidate = true;
        });
        if (hasCurrent && hasCandidate) return "both";
        if (hasCurrent) return "current";
        if (hasCandidate) return "candidate";
        return "none";
    }

    function getColor(status) {
        switch(status) {
            case "current": return COLOR_CURRENT;
            case "candidate": return COLOR_CANDIDATE;
            case "both": return COLOR_BOTH;
            default: return COLOR_DEFAULT;
        }
    }

    function getPopupContent(countryName, partners) {
        let html = `<div class="popup-header">${countryName}</div><ul class="partner-list">`;
        partners.forEach(p => {
            let tagClass = p.type.includes("Current") ? "tag-current" : "tag-candidate";
            html += `<li>
                        <b>${p.code}</b><br>
                        ${p.name}
                        <span class="tag ${tagClass}">${p.type === "Current Associated" ? "Assoc. Partner" : (p.type === "Candidate Associated" ? "Candidate" : "Partner")}</span>
                     </li>`;
        });
        html += "</ul>";
        return html;
    }

    // --- Init Map ---
    const map = L.map('map').setView([20.0, 10.0], 2); 

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // Fetch Data
    fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
        .then(response => response.json())
        .then(data => {
            L.geoJson(data, {
                style: function(feature) {
                    const name = feature.properties.name;
                    let key = name;

                    if (name === "Republic of Korea") key = "South Korea"; 
                    if (name === "Republic of Serbia") key = "Serbia";
                    if (name === "The Netherlands") key = "Netherlands";
                    if (name === "United Republic of Tanzania") key = "Tanzania";
                    
                    const partners = partnerData[key];
                    const status = partners ? getCountryStatus(partners) : "none";

                    return {
                        fillColor: getColor(status),
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    const name = feature.properties.name;
                    let key = name;
                    
                    if (name === "Republic of Korea") key = "South Korea"; 
                    if (name === "Republic of Serbia") key = "Serbia";
                    if (name === "The Netherlands") key = "Netherlands";
                    
                    const partners = partnerData[key];

                    if (partners) {
                        layer.bindPopup(getPopupContent(key, partners));
                        layer.on({
                            mouseover: function(e) {
                                var layer = e.target;
                                layer.setStyle({ weight: 2, color: '#666', fillOpacity: 0.9 });
                                layer.openPopup();
                            },
                            mouseout: function(e) {
                                var layer = e.target;
                                layer.setStyle({ weight: 1, color: 'white', fillOpacity: 0.7 });
                            }
                        });
                    }
                }
            }).addTo(map);
        });

    // --- Add Stats Panel ---
    var statsControl = L.control({position: 'topright'});

    statsControl.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info stats');
        var stats = calculateStats();
        
        // Build HTML
        var html = `
            <div class="stats-header">Project Statistics</div>
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-number">${stats.currentPartners}</span><span class="stat-label">Partners</span></div>
                <div class="stat-item"><span class="stat-number">${stats.associatedPartners}</span><span class="stat-label">Assoc. Partners</span></div>
                <div class="stat-item"><span class="stat-number">${stats.candidatePartners}</span><span class="stat-label">Candidates</span></div>
                <div class="stat-item"><span class="stat-number">${stats.countries}</span><span class="stat-label">Countries</span></div>
                <div class="stat-item" style="grid-column: span 2"><span class="stat-number">${stats.continents.size}</span><span class="stat-label">Continents</span></div>
            </div>
            
            <div class="partner-scroll">
                <div class="list-section">
                    <h5>Current Partners</h5>
                    <ul>${stats.lists.current.map(s => `<li>${s}</li>`).join('')}</ul>
                </div>
                <div class="list-section">
                    <h5>Associated Partners</h5>
                    <ul>${stats.lists.associated.map(s => `<li>${s}</li>`).join('')}</ul>
                </div>
                <div class="list-section">
                    <h5>Candidate Partners</h5>
                    <ul>${stats.lists.candidate.map(s => `<li>${s}</li>`).join('')}</ul>
                </div>
            </div>
        `;
        div.innerHTML = html;
        
        // Disable map movement when scrolling the list
        L.DomEvent.disableScrollPropagation(div);
        L.DomEvent.disableClickPropagation(div);
        
        return div;
    };
    statsControl.addTo(map);

    // --- Legend ---
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend');
        div.innerHTML += '<h4>Legend</h4>';
        div.innerHTML += '<i style="background:' + COLOR_CURRENT + '"></i> Current Partners<br>';
        div.innerHTML += '<i style="background:' + COLOR_CANDIDATE + '"></i> Candidate Partners<br>';
        div.innerHTML += '<i style="background:' + COLOR_BOTH + '"></i> Covered by Both<br>';
        return div;
    };
    legend.addTo(map);

</script>
</body>
</html>
